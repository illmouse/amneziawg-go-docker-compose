# AmneziaWG - Docker Compose

Автоматизация запуска **AmneziaWG** через Docker Compose. Проект направлен на сокращение времени, затрачиваемого на развертывание и поддержку WG-тоннелей, и базируется на официальном Docker-образе [amneziawg-go](https://hub.docker.com/r/amneziavpn/amneziawg-go) от команды [Amnezia](https://amnezia.org/).

# Возможности

* Установка и запуск одной командой
* Простая конфигурация через файл `.env`
* Поддержка "серверного" и "клиентского" режимов
* Поддержка протокола AmneziaWG версии 2.0
* Автоматическая конфигурация пиров и генерация конфигурационных файлов для клиентов
* Прозрачный прокси-сервер [3proxy](https://3proxy.ru/) для проксирования запросов через контейнер в клиентском режиме (HTTP(S)/SOCKS5)
* Мониторинг и автоматическое переключение между пирами в случае отказа туннеля

# Использование

## Базовая установка

> Проверено на Ubuntu 24 / Debian 12.
> Скрипт должен запускаться **от root** или через `sudo`.

### 1️⃣ Клонируем репозиторий

```bash
git clone https://github.com/illmouse/amneziawg-go-docker-compose.git
cd amneziawg-go-docker-compose
```

### 2️⃣ Запускаем скрипт автоматической установки

```bash
chmod +x setup.sh && sudo ./setup.sh
```

**Скрипт:**

* Устанавливает Docker и Docker Compose
* Настраивает параметры ядра системы
* Добавляет правила ротации логов
* Предлагает выбрать режим установки: серверный (по умолчанию) или клиентский
* Создает файл `.env` интерактивно
* Автоматически запускает контейнер AmneziaWG

## Проверка установки

Проверяем, что контейнер запущен:

```bash
docker ps
```

Просмотр логов сервера:

```bash
docker logs amneziawg -f
```

# Серверный режим

Режим запуска определяется переменной `WG_MODE=server`.

В серверном режиме контейнер поддерживает множество входящих подключений от пиров. Создается конфигурация интерфейса WireGuard и пиров, которые используют эту конфигурацию для подключения.

Конфигурации клиентов, созданные в серверном режиме, находятся в `config/server_peers/`.

## Переменные серверного режима

[Описание переменных](#описание-переменных)

```ini
WG_MODE=server
WG_IFACE=wg0
WG_PORT=13440
WG_ADDRESS=10.100.0.1/24
WG_PEER_COUNT=5
WG_ENDPOINT=<ip-сервера>

Jc=3
Jmin=20
Jmax=150
S1=70
S2=150
S3=25
S4=76
H1=300
H2=350
H3=400
H4=450
```

## Изменение количества пиров

* При увеличении значения `WG_PEER_COUNT` будут добавлены новые пиры в числовом порядке.
* При уменьшении значения `WG_PEER_COUNT` лишние пиры будут удалены начиная с конца. Их конфигурационные файлы архивируются, а записи удаляются из базы данных `config/config.json`.

# Клиентский режим

Режим запуска определяется переменной `WG_MODE=client`.

В клиентском режиме контейнер подключается к одному пиру с возможностью автоматического переключения на следующий доступный пир при недоступности текущего.

Конфигурации пиров для подключения находятся в `config/client_peers/`.

## Переменные клиентского режима

[Описание переменных](#описание-переменных)

```ini
WG_MODE=client
MASTER_PEER=peer1.conf

PROXY_ENABLED="true"
PROXY_PORT_HTTP="3128"
PROXY_PORT_SOCKS5="4128"
```

## Использование протокола версии 2.0

В клиентском режиме по-умолчанию "зашито" использование обфускации через UDP протокол. Если в конфигурации пира не указаны параметры I1-I5, то по умолчанию выбирается DEFAULT протокол обфускации и автоматически генерируются параметры I2-I5.

В файле .env можно задать один из предустановленных протоколов UDP используя параметр `UDP_SIGNATURE`. Доступные значения указаны в [описании переменных](#описание-переменных).

# Работа внутреннего мониторинга

Логи мониторинга сохраняются в `logs/amneziawg.log`.

Скрипт мониторинга проверяет доступность туннеля через ping на адрес 9.9.9.9.

* В **серверном режиме** скрипт продолжает проверку хелсчеков без изменений.
* В **клиентском режиме** при недоступности текущего пира происходит попытка переключения на следующий доступный пир.

Если задана переменная `MASTER_PEER`, логика работы изменяется:

* При старте контейнера в клиентском режиме всегда выбирается указанный мастер-пир, а не первый по алфавиту.
* Мастер-пир проверяется отдельно (через проверку UDP-порта эндпоинта с помощью netcat).
* Если мастер-пир снова становится доступным, туннель принудительно переключается на него.

# Логи

Логи сохраняются в директориях:

```ini
logs/
logs/3proxy/
```

Скрипт [setup.sh](setup.sh) добавляет конфигурацию logrotate для автоматической ротации логов, чтобы предотвратить переполнение диска.

Настройки logrotate:

```ini
daily
missingok
rotate 30
compress
delaycompress
notifempty
copytruncate
dateext
dateformat -%Y-%m-%d
maxage 30
```

# Полный сброс конфигурации

Для полного сброса:

```bash
rm -rf config/*
docker compose down -v
sudo ./setup.sh
```

Будут пересозданы:

* Ключи сервера
* Конфигурации пиров
* База данных
* `.env`

# Описание переменных

| Название переменной | Доступные значения              | Значение по умолчанию             | Описание                                                                                                               |
| ------------------- | ------------------------------- | --------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| WG_MODE             | `server`, `client`              | `server`                          | Режим запуска контейнера                                                                                               |
| WG_IFACE            | любое корректное имя интерфейса | `wg0`                             | Имя сетевого интерфейса WireGuard внутри контейнера                                                                    |
| WG_PORT             | 1–65535                         | `13440`                           | Порт, на котором WireGuard будет доступен на хосте                                                                     |
| WG_ADDRESS          | любой корректный IP/маска       | `10.100.0.1/24`                   | Адрес для сети WireGuard. Пиры получают /32 по умолчанию                                                               |
| WG_PEER_COUNT       | целое число ≥ 1                 | `1`                               | Количество пиров, для которых будут созданы конфигурации                                                               |
| WG_ENDPOINT         | любой корректный IP             | `<IP сервера>` (автоопределяется) | IP хоста для генерации клиентских конфигураций. Пиры подключаются к этому IP                                           |
| Параметры обфускации (`Jc`, `Jmin`, `Jmax`, `S1`, `S2`, `S3`, `S4`, `H1`, `H2`, `H3`, `H4`) | [описание параметров](https://docs.amnezia.org/documentation/amnezia-wg/#how-it-works)          | генерируется автоматически скриптом `setup.sh` |                  |
| MASTER_PEER         | имя файла конфигурации пира     | нет                               | Имя конфигурационного файла в `config/client_peers/` для основного пира. Если не задано, выбирается первый по алфавиту |
| UDP_SIGNATURE        |  DEFAULT,DNS,QUIC    | DEFAULT                              | код UDP протокола, который будет использоваться для обфускации соединения. В коде DEFAULT установлена сигнатура VoIP с ресурса https://voidwaifu.github.io/Special-Junk-Packet-List/ |
| PROXY_ENABLED       | `true`, `false`                 | `true`                            | Включение прокси-сервера в клиентском режиме                                                                     |
| PROXY_PORT_HTTP          | 1–65535                         | `3128`                            | Порт, на котором будет запущен HTTP прокси                                                                                   |
| PROXY_PORT_SOCKS5          | 1–65535                         | `4128`                            | Порт, на котором будет запущен SOCKS5 прокси                                                                                   |
| LOG_LEVEL             | `ERROR`, `INFO`, `WARN`, `DEBUG` | `INFO`                            | Уровень детализации логирования                                                                                        |
| MON_CHECK_IP          | любой корректный IP             | `9.9.9.9`                         | IP-адрес для проверки доступности туннеля через ping                                                                   |
| MON_CHECK_INTERVAL    | целое число ≥ 1                 | `10`                              | Интервал в секундах между проверками мониторинга                                                                       |
| MON_CHECK_TIMEOUT     | целое число ≥ 1                 | `10`                              | Таймаут ping в секундах для проверки доступности                                                                       |
