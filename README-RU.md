# AmneziaWG Docker VPN

Этот репозиторий содержит **Docker-набор для AmneziaWG** — VPN, похожий на WireGuard, используя контейнер `amneziavpn/amneziawg-go:0.2.15`.  
Конфигурации сервера и клиента создаются динамически, ключи управляются автоматически, что делает систему удобной и повторно используемой.

---

## Особенности

- Автоматическая генерация серверных и клиентских ключей при первом запуске.
- Динамическая генерация конфигураций сервера и клиента на основе переменных окружения.
- Клиентская конфигурация (`peer.conf`) готова к использованию.
- Логи выводятся в `docker logs`.
- Повторное использование: после генерации ключей и конфигов контейнер просто запускает VPN без повторной генерации.

---

## Переменные окружения (`.env`)

Файл `.env` позволяет настраивать контейнер. Разместите его рядом с `docker-compose.yml`.  
Пример:

```bash
# .env
WG_IFACE=wg0                      # Имя VPN-интерфейса внутри контейнера
WG_ADDRESS=10.100.0.1/24          # IP сервера и подсеть
WG_CLIENT_ADDR=10.100.0.2/32      # IP клиента
WG_PORT=13440                     # Порт для VPN на котором будет приниматься подключение
WG_ENDPOINT=                      # Публичный endpoint; оставьте пустым для автоопределения

# Настраиваемые параметры AmneziaWG
Jc=3                           
Jmin=1
Jmax=50
S1=25
S2=72
H1=1411927821
H2=1212681123
H3=1327217326
H4=1515483925
````

**Примечания:**

* Если `WG_ENDPOINT` пуст, контейнер автоматически определяет внешний IP через `ifconfig.me`.
* Параметры `Jc`, `Jmin`, `Jmax`, `S1`, `S2`, `H1-H4` важны для работы VPN. Не изменяйте их без необходимости.

---

## Как это работает

1. **Первый запуск:**

   * Контейнер проверяет ключи и конфиги в `/etc/amneziawg` (подключено через Docker volume).
   * Если чего-то нет, генерирует:

     * Серверные ключи (`privatekey`, `publickey`, `presharedkey`)
     * Клиентский ключ (`client_privatekey`)
     * Серверный конфиг (`wg0.conf`)
     * Клиентский конфиг (`peer.conf`)
   * Устанавливает права `600` для всех ключей.
   * Запускает VPN-интерфейс (`WG_IFACE`) и применяет NAT/iptables через него.

2. **Последующие запуски:**

   * Контейнер находит существующие ключи/конфиги и пропускает генерацию ключей.
   * Новая конфигурация генерируется с найденными ключами или генерируются новые.
   * Новая конфигурация сравнивается с существующей и заменяется если они различаются.
   * Запускает VPN и применяет NAT/iptables.
   * Логи доступны через `docker logs`.

3. **Клиентская конфигурация:**

   * Доступна в `/etc/amneziawg/peer.conf`.
   * Можно скопировать на клиентское устройство для подключения.

---

## Пример Docker Compose

```yaml
version: "3.9"

services:
  amneziawg:
    image: amneziavpn/amneziawg-go:0.2.15
    container_name: amneziawg
    env_file:
      - .env
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${WG_PORT}:${WG_PORT}/udp"
    volumes:
      - ./config:/etc/amneziawg
    restart: always
```

**Примечания:**

* `./config` используется для хранения ключей и конфигураций.
* Если директория пуста, контейнер автоматически создаст ключи и конфиги.
* VPN-трафик NATится через интерфейс `WG_IFACE`.

---

## Использование

1. **Создайте директорию для конфигов:**

```bash
mkdir -p ./config
chmod 700 ./config
```

2. **Создайте файл `.env`** с необходимыми параметрами.

3. **Запустите контейнер:**

```bash
docker-compose up -d
```

4. **Просмотр логов:**

```bash
docker logs -f amneziawg
```

5. **Получение клиентской конфигурации:**

```bash
docker cp amneziawg:/etc/amneziawg/peer.conf ./peer.conf
```

Используйте `peer.conf` на клиентском устройстве для подключения к VPN.

---

## Важные замечания

* Для полной регенерации VPN-конфигурации можно удалить содержимое `./config`. При следующем запуске контейнер создаст новые ключи и конфиги.
* Убедитесь, что UDP-порт (`WG_PORT`) открыт на роутере/фаерволе для подключения клиентов.