#!/bin/bash
set -eu

# ===============================
# Load .env if exists
# ===============================
ENV_FILE="/etc/amneziawg/.env"
if [ -f "$ENV_FILE" ]; then
    set -o allexport
    . "$ENV_FILE"
    set +o allexport
fi

# ===============================
# Environment defaults
# ===============================

# Logging and directories
: "${WG_LOGFILE:=/var/log/amneziawg/amneziawg.log}"
: "${WG_DIR:=/etc/amneziawg}"
: "${TMP_DIR:=/tmp/amneziawg}"
: "${CLIENT_PEERS_DIR:=$WG_DIR/client_peers}"
: "${SERVER_PEERS_DIR:=$WG_DIR/server_peers}"
: "${CONFIG_DB:=$WG_DIR/config.json}"
: "${WG_CONF_FILE:=wg0.conf}"
: "${KEYS_DIR:=$WG_DIR/keys}"
: "${LOG_LEVEL:=INFO}"

# WireGuard defaults
: "${WG_IFACE:=wg0}"
: "${WG_ADDRESS:=10.100.0.1/24}"
: "${WG_PORT:=13440}"
: "${WG_ENDPOINT:=}"
: "${WG_PEER_COUNT:=1}"

# Squid defaults
: "${SQUID_ENABLE:=true}"
: "${SQUID_PORT:=3128}"
: "${SQUID_CACHE:=/var/cache/squid}"
: "${SQUID_LOG:=/var/log/amneziawg/squid/access.log}"
: "${SQUID_EMOJI:=ðŸ¦‘}"

# Junk/obfuscation values
: "${Jc:=3}"
: "${Jmin:=1}"
: "${Jmax:=50}"
: "${S1:=25}"
: "${S2:=72}"
: "${H1:=1411927821}"
: "${H2:=1212681123}"
: "${H3:=1327217326}"
: "${H4:=1515483925}"

: "${UDP_SIGNATURE:=DEFAULT}"
PROTOCOL_MAP=(
    ["DEFAULT"]="<b 0x5245474953544552207369703a676f6f676c652e636f6d205349502f322e300d0a5669613a205349502f322e302f554450203139322e3136382e3137312e343a353036303b6272616e63683d7a39684734624b3061393661653138633830306635306337343232666239610d0a4d61782d466f7277617264733a2037300d0a546f3a203c7369703a7573657240676f6f676c652e636f6d3e0d0a46726f6d3a203c7369703a7573657240676f6f676c652e636f6d3e3b7461673d373134393931303661396363656437630d0a43616c6c2d49443a2063313136376162646665333730626632653831336533663539626265623862300d0a435365713a20312052454749535445520d0a436f6e746163743a203c7369703a75736572403139322e3136382e3234342e3131333a353036303e0d0a557365722d4167656e743a204d6963726f5349502f332e302e300d0a457870697265733a20323336340d0a436f6e74656e742d4c656e6774683a20300d0a0d0a>"
)

# Export all variables for other scripts
export WG_DIR TMP_DIR CLIENT_PEERS_DIR SERVER_PEERS_DIR CONFIG_DB WG_CONF_FILE WG_LOGFILE KEYS_DIR LOG_LEVEL
export WG_IFACE WG_ADDRESS WG_PORT WG_ENDPOINT WG_PEER_COUNT
export SQUID_ENABLE SQUID_PORT SQUID_CACHE SQUID_LOG SQUID_EMOJI
export Jc Jmin Jmax S1 S2 H1 H2 H3 H4 UDP_SIGNATURE PROTOCOL_MAP
