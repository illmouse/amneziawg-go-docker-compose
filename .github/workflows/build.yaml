name: Build All Branches
on:
  push:
    branches: ['**']

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: quay.io/buildah/stable:latest
      options: --privileged --device /dev/fuse
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Sanitize branch name
      id: sanitize
      run: |
        BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
        echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT

    - name: Login to GHCR
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | buildah login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build image
      run: |
        # Always build SHA tag
        TAGS="--tag ghcr.io/${{ github.repository_owner }}/amneziawg-go:${{ github.sha }}"
        
        # Add appropriate tag based on branch
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          TAGS="$TAGS --tag ghcr.io/${{ github.repository_owner }}/amneziawg-go:latest"
        else
          TAGS="$TAGS --tag ghcr.io/${{ github.repository_owner }}/amneziawg-go:${{ steps.sanitize.outputs.branch }}-latest"
        fi
        
        buildah bud $TAGS .

    - name: Push tags
      run: |
        # Always push SHA tag
        echo "Pushing SHA tag: ${{ github.sha }}"
        buildah push ghcr.io/${{ github.repository_owner }}/amneziawg-go:${{ github.sha }}
        
        # Push appropriate branch tag
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "Pushing latest tag"
          buildah push ghcr.io/${{ github.repository_owner }}/amneziawg-go:latest
        else
          echo "Pushing branch tag: ${{ steps.sanitize.outputs.branch }}-latest"
          buildah push ghcr.io/${{ github.repository_owner }}/amneziawg-go:${{ steps.sanitize.outputs.branch }}-latest
        fi